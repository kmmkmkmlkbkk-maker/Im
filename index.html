<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© | Ø§Ù„Ù…Ø¯ÙŠØ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <style>
        :root {
            --bg-deep: #020617;
            --card-bg: rgba(15, 23, 42, 0.8);
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
        }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-deep); color: white; overflow-x: hidden; }
        
        .fluid-glass {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border-radius: 2rem;
        }

        .input-code {
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            letter-spacing: 2px;
            transition: 0.3s;
        }
        .input-code:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); }

        .btn-enter {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 5px 20px rgba(37, 99, 235, 0.4);
        }
        
        .request-card {
            transition: all 0.3s ease;
            border-right: 4px solid transparent;
        }
        .request-card:hover {
            transform: translateX(-5px);
            border-right-color: var(--primary);
            background: rgba(30, 41, 59, 0.9);
        }

        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">

    <!-- Login Section -->
    <section id="login-panel" class="w-full max-w-sm flex flex-col justify-center min-h-[80vh] text-center">
        <div class="fluid-glass p-10 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-600/20 rounded-full blur-3xl"></div>
            
            <div class="w-20 h-20 bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-6 text-4xl text-blue-500 shadow-xl border border-slate-700">
                <i class="fas fa-user-shield"></i>
            </div>
            
            <h1 class="text-2xl font-black mb-2">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø¯ÙŠØ±</h1>
            <p class="text-gray-500 text-xs mb-8">Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø®Ø§Øµ Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù†Ø¸Ø§Ù…</p>
            
            <input type="password" id="access-code" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" class="input-code w-full p-4 rounded-xl text-xl font-bold mb-6 text-white placeholder-gray-600">
            
            <button onclick="checkCode()" class="btn-enter w-full py-4 rounded-xl font-black text-lg transition hover:scale-[1.02]">
                Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
            </button>
            <p id="error-msg" class="text-red-500 text-xs mt-4 hidden font-bold">Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ â›”</p>
        </div>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboard-panel" class="hidden w-full max-w-4xl pt-10">
        
        <!-- Header -->
        <header class="flex justify-between items-center mb-10 fluid-glass p-6">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-xl font-bold border-4 border-[#020617]">A</div>
                <div>
                    <h2 class="font-black text-lg">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</h2>
                    <p class="text-xs text-green-400 font-bold flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</p>
                </div>
            </div>
            <button onclick="logout()" class="bg-red-500/10 text-red-500 p-3 rounded-xl hover:bg-red-500 hover:text-white transition"><i class="fas fa-power-off"></i></button>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="fluid-glass p-6 border-b-4 border-blue-500">
                <p class="text-gray-400 text-xs font-bold mb-2 uppercase">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
                <h3 class="text-4xl font-black text-white" id="count-pending">0</h3>
            </div>
            <div class="fluid-glass p-6 border-b-4 border-green-500 opacity-60">
                <p class="text-gray-400 text-xs font-bold mb-2 uppercase">ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</p>
                <h3 class="text-4xl font-black text-green-400">--</h3>
            </div>
        </div>

        <!-- Requests List -->
        <h3 class="text-xl font-black mb-6 flex items-center gap-2"><i class="fas fa-list text-blue-500"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
        
        <div id="requests-container" class="space-y-4">
            <!-- Requests injected here -->
            <div class="text-center py-20 opacity-30">
                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            </div>
        </div>

    </section>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, collection, onSnapshot, runTransaction, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„Ø¶Ø¨Ø·
        const firebaseConfig = {
            apiKey: "AIzaSyAuWgWjxvlwVLt_nxoA0g_Z_k21Yn2MuJ8",
            authDomain: "power-4ec4d.firebaseapp.com",
            projectId: "power-4ec4d",
            storageBucket: "power-4ec4d.firebasestorage.app",
            messagingSenderId: "346740944193",
            appId: "1:346740944193:web:087296b7dc7bcca6c7c5c0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ Ù†ÙØ³ ID Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„ÙƒÙŠ ØªØ¸Ù‡Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const appId = 'we-are-here-3d-final'; 

        const SECRET_PASS = "07709922114AAA";

        // --- Logic ---

        window.checkCode = () => {
            const input = document.getElementById('access-code').value;
            if (input === SECRET_PASS) {
                document.getElementById('login-panel').classList.add('hidden');
                document.getElementById('dashboard-panel').classList.remove('hidden');
                startListening();
            } else {
                const err = document.getElementById('error-msg');
                err.classList.remove('hidden');
                err.classList.add('animate-bounce');
                setTimeout(() => err.classList.remove('animate-bounce'), 1000);
            }
        };

        window.logout = () => location.reload();

        function startListening() {
            const reqRef = collection(db, 'artifacts', appId, 'public', 'data', 'deposit_requests');
            
            onSnapshot(reqRef, (snapshot) => {
                const container = document.getElementById('requests-container');
                const pendingCount = document.getElementById('count-pending');
                
                pendingCount.innerText = snapshot.size;
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="fluid-glass p-12 text-center opacity-40">
                            <i class="fas fa-check-circle text-5xl mb-4 text-green-500"></i>
                            <p class="font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                        </div>
                    `;
                    return;
                }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const id = docSnap.id;
                    const time = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString('ar-IQ') : 'Ø§Ù„Ø¢Ù†';

                    const card = document.createElement('div');
                    card.className = "fluid-glass p-6 flex flex-col md:flex-row justify-between items-center gap-6 request-card fade-in";
                    card.innerHTML = `
                        <div class="flex-1 text-right w-full">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-blue-600 text-white text-[10px] px-2 py-1 rounded font-bold">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</span>
                                <h4 class="font-black text-lg">${data.userName}</h4>
                            </div>
                            <div class="flex items-center gap-2 text-xs text-gray-400 font-mono mb-3">
                                <i class="fas fa-id-badge"></i> ${data.userId}
                                ${data.userDisplayId ? `<span class="bg-slate-700 px-2 rounded text-white font-bold">ID: ${data.userDisplayId}</span>` : ''}
                            </div>
                            <div class="bg-black/30 p-3 rounded-lg border border-dashed border-gray-600 inline-block w-full md:w-auto">
                                <p class="text-[10px] text-gray-500 font-bold mb-1">Ø±Ù…Ø² Ø§Ù„ÙƒØ§Ø±Øª</p>
                                <p class="text-xl font-mono text-yellow-500 font-bold tracking-widest select-all">${data.cardCode}</p>
                            </div>
                        </div>

                        <div class="text-center px-6">
                            <p class="text-xs text-gray-500 font-bold mb-1">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</p>
                            <p class="text-3xl font-black text-blue-400">${data.gems.toLocaleString()} ğŸ’</p>
                            <p class="text-[10px] text-gray-600 mt-1">${time}</p>
                        </div>

                        <div class="flex gap-3 w-full md:w-auto">
                            <button onclick="approve('${id}', '${data.userId}', ${data.gems})" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-xl font-bold shadow-lg shadow-green-600/20 transition transform hover:scale-105">
                                <i class="fas fa-check ml-2"></i> Ù…ÙˆØ§ÙÙ‚Ø©
                            </button>
                            <button onclick="reject('${id}')" class="bg-slate-700 hover:bg-red-600 text-white py-3 px-4 rounded-xl transition hover:shadow-lg hover:shadow-red-600/20">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            });
        }

        // --- Actions ---

        window.approve = async (docId, userId, amount) => {
            if (!confirm("Ù‡Ù„ Ø§Ù„ÙƒØ§Ø±Øª ØµØ­ÙŠØ­ØŸ Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± ÙÙˆØ±Ø§Ù‹.")) return;

            const userRef = doc(db, 'artifacts', appId, 'users', userId, 'profile', 'data');
            const reqRef = doc(db, 'artifacts', appId, 'public', 'data', 'deposit_requests', docId);

            try {
                await runTransaction(db, async (transaction) => {
                    // Check if request still exists
                    const reqDoc = await transaction.get(reqRef);
                    if (!reqDoc.exists()) throw "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!";

                    // Add gems to user
                    transaction.update(userRef, { balance: increment(amount) });
                    
                    // Delete request
                    transaction.delete(reqRef);
                });
                // alert("ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            } catch (e) {
                alert("Ø®Ø·Ø£: " + e.message);
            }
        };

        window.reject = async (docId) => {
            if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'deposit_requests', docId));
        };

    </script>
</body>
</html>